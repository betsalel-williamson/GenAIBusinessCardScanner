echo "Running pre-commit hook..."

# Run markdown formatter (runs unconditionally as it's fast and fixes issues)
echo "Running markdown formatter..."
pnpm run markdown-format

# Run pre-commit checks for validation_tool.ts if there are staged changes in its directory
if git diff --cached --quiet -- validation_tool.ts; then
  echo "No staged changes in validation_tool.ts, skipping pre-commit checks."
else
  echo "Running pre-commit checks for validation_tool.ts"
  (cd validation_tool.ts && pnpm run precommit-checks)
fi

# Run pre-commit checks for dagster_business_automations (Python) if there are staged changes in its directory
if git diff --cached --quiet -- dagster_business_automations; then
  echo "No staged changes in dagster_business_automations, skipping pre-commit checks."
else
  echo "Running pre-commit checks for dagster_business_automations"
  (cd dagster_business_automations && \
    python3.12 -m venv .venv && \
    source .venv/bin/activate && \
    pip install --upgrade pip && \
    pip install . && \
    bash lint.sh && \
    bash test.sh)
fi

# Run pre-commit checks for dbt_project if there are staged changes in its directory
if git diff --cached --quiet -- dbt_project; then
  echo "No staged changes in dbt_project, skipping pre-commit checks."
else
  echo "Running dbt build for dbt_project"
  # Use the dbt executable from the dagster_business_automations virtual environment
  (cd dbt_project && ../dagster_business_automations/.venv/bin/dbt build --vars '{is_ci_run: true}')
fi

git update-index --again